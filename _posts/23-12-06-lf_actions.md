---
layout: post
title: リストファイル上で仮想エントリを活用する
version: PPx194, ppm0.93.11以降
date: 2023-12-09
comment: 改稿。
repository: tar80/ppx-plugin-manager
categories: PPc @plugin
---

### 説明

PPcは、リアルタイムにエントリリストをフィルタリングできますが、
これは他のファイラにはなかなかない機能だと思います。Migemoも使えて優秀です。  
そんな有用なフィルタリング機能をより活用すべく、仮想エントリというしくみを作りました。  
<BR>
仮想エントリというのは、ファイル名に文字列を設定したリストファイルのエントリで、
エントリリストのフィルタリング対象として扱えます。が、ただ文字列をフィルタリングできても
使い道がないため、実体のパス(長いファイル名)をリストファイル内部データの~~短いファイル名~~コメントに設定し、
文字列とファイル名を関連付けています。  
~~通常のエントリとは異なるので問題点がいくつかありますが、その一つとして短いファイル名は
PPc のエントリリスト上では12文字に制限され、マクロ文字`%FCS`ではフルパスを参照できないというものがあります。  
これを解決するため、内部データから直接エントリのパラメータを取得しコマンドに渡すスクリプト、~~  
lfActions.js と連携して運用します。  
<BR>
lfActions.js は ppm-listfile に内包されている lf_execute.js の次版として作っていて、
リストファイル上のパスを渡したときに、リストファイルに応じたコマンドを実行できます。  
lf_execute.js は実行するコマンドを分割したスクリプトに記述する方式でとてもわかり難いものでしたが、  
lfActions.js では`S_ppm#actions`に登録でき、多少わかり易くなったと思います。  
現在はプラグイン側が対応できていませんが追々対応していきます。

### 設定

lfActions.js の利用には二段階の設定が必要になります。

1. lfAction.js 呼び出し用の設定  
   以下は PPv にパスを渡す設定例です。  
   一行目で、リストファイルのときだけスクリプトを呼んでいます。
   リストファイル用のコマンドが登録されていればそれを実行し、呼び出し側のコマンドを終了します。
   通常のリストファイルが渡されたときは何もせずに二行目に進みます。

   ```clean
   XC_main = {
   V , *if 4==%*js("PPx.result=PPx.DirectoryType;") %: *script %sgu'ppmlib'\lfActions.js,ppv
       viewer
   }
   ```

1. リストファイルに応じた仮想エントリを処理するコマンドの登録  
    コマンドは、S_ppm#actions に登録しますが、 subid には命名規則があります。  
    ppm プラグインが生成したリストファイルのメタ情報には`;ppm=xxx`の行があり、
   この値を`プラグインエイリアス`と呼びます。また、lfActions.jsの第一引数に指定する
   コマンド名を`コマンドエイリアス`を呼びます。この2つのエイリアスをアンダースコア
   でつないだものを subid とします。  
   `実行されるコマンド`内では変数が使えます。(後述)

   ```clean
   S_ppm#actions = {
   <プラグインエイリアス>_<コマンドエイリアス> = <実行されるコマンド>
   }
   ```

[エントリリストにコメントを展開]({{ site.baseurl }}{% post_url 23-12-06-lf_comment %})のコメントエントリを開く設定はこのようになっています。
<BR>

| 説明                       | エイリアス  |
| :------------------------- | :---------- |
| リストファイル内のメタ情報 | comment     |
| スクリプトに渡す第一引数   | ppv         |
| S_ppm#actionsのコマンド名  | comment_ppv |

#### スクリプトの説明

`lfActions.js,1,2,3`

- 第1引数 `<コマンド名>`  
  実行したいコマンドのエイリアスを指定します。
- 第2引数 `"enclose"`(default) | `"double"` | `"escape"`  
  パスに空白が含まれるとき`"`で括る、`""`で括る、`\\ `でエスケープするのいずれかを選択できます。
- 第3引数
  `"0"`以外の値のとき、重複したパスを実行対象に含めます。
- ~~第4引数 `"utf8"`(default) | `"utf16le"`  
   リストファイルのエンコードを指定できます。リストファイルを utf16le で
  生成しているときはこちらも指定してください。~~不要になりました。

複数のエントリがまとめてコマンドに渡されるとき、パスは空白区切りで渡されます。

##### 実行されるコマンドで使用できる変数

`S_ppm#actions`に登録されたコマンドは、そのまま実行されるわけではなく
コマンド内の変数が値に変換されてから実行されます。実際には、
`*execute ,%*regexp("%(リストファイル内部データ%)","%(/RegExp/<コマンド>/%)")`
相当を実行します。

<BR>

| 使える変数 | 説明                            |
| :--------- | :------------------------------ |
| ${path}    | 対象となるファイルパス          |
| ${base}    | メタ情報`;Base=<path>\|dirtype` |
| ${dirtype} | メタ情報`;Base=path\|<dirtype>` |
| ${search}  | メタ情報`;Search=<word>`        |
| ${dup}     | 重複したパス `1`か`0`           |
| ${att}     | 対象エントリの属性値            |
| ${hl}      | 対象エントリのハイライト        |
| ${option}  | 対象エントリの短いファイル名    |

> ${dup}は一度実行されたパスに`1`を返します  
> ${option}にはオプション値が設定されます

通常使える変数は`${path}`と`${search}`で、コマンド実行時にまとめてパスが渡されます。  
リストファイル内にメタ情報`;freq=every`の記述があるときは、すべての変数を利用でき  
パスごとにコマンド実行されます。(ppm-grepで使用予定)

##### 設定例

```clean
S_ppm#actions = {
comment_ppv = *ppv ${path} -k *find ${search}
comment_editor = editor "${path}"
grep_ppv = *if ${dup}!=1 %: *ppv ${path} -k *find ${search} %: *jumpline L ${sname}
}
```

> grepは今後対応予定。
